<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>MapTest</title>
    
<link rel="stylesheet" href="lib/theme/default/style.css" type="text/css">
<link rel="stylesheet" type="text/css" href="openlayers.css">
<link rel="stylesheet" type="text/css" href="maptest.css">

</head>

<body onload="initPage()">
	<div class='page-header'>
		<table style='width:100%'>
			<tr>
				<td><div class='page-title'>MapTest</div>
				<td></td>
				<td align='right'><a id='map-link' target='_blank' href=''>Permalink</a> <button id='btn-help' class='btn-help' title='Show Help'>?</button></td>
			</tr>
		</table>


</div>
			<!-- Help panel -->	
			<div class='help-panel' style='display: none;'>
				<div class='btn-close' id='btn-help-close'>x</div>
				<div class='help-content' style='margin-left:0px;margin-top:10px;'>
<h1>Map Tester</h1>

Supports displaying WMS and ArcGIS REST map services as map overlays.

<h2>Map Service Configuration</h2>

<h3>URL</h3>

Basic configuration can be loaded via URL parameters.  

<pre>
http://apphost/maptest.html 
         [ ?host=http://some.host/mapservice ] 
         [ &amp;lyr=LYRA,LYRB,LYRC ] 
         [ &amp;extent=MIN_LON,MIN_LAT,MAX_LON,MAX_LAT ]
</pre>

<p>
The <b>Permalink</b> opens a new page with the top map overlay as parameters.

<ul>
	<li><code>host</code>, <code>lyr</code>, <code>extent</code> parameters are optional</li>
</ul>

<h3>Text</h3>

Map services are configured by a simple text configuration format.
The configuration schema contains the following:
<ul>
	<li><b>URL</b> for the map service</li>
	<li>(Optional) <b>Metadata link</b> specified as <code>meta-url: link</code> </li>
	<li>(Optional, multiple) <b>URL parameter</b> specified as <code>param: name=value</code> </li>
	<li>A list of one or more map service <b>layers</b>
		<ul>
			<li>Layer names can be comma-separated or on separate lines</li>
			<li>A layer can be specified as visible by appending <code>+</code> </li>
			<li>A layer style can be specified by appending <code>*style</code> </li>
		</ul>
		</li>
</ul>

Multiple services can be configured, separated by a blank line.

<p>
<h4>Example configuration for a single map service</h4>
<pre>
http://some.host/mapservice
meta-url: http://some.host/mapservice/meta
param: name=value
param: name2=value2
LAYER1,LAYER2
LAYER3+
LAYER4*STYLE
</pre>

<h2>User Interface</h2> 
<h3>Overlays & Layers</h3>

Add layers to an overlay by entering one or more layer names (comma-separated).

<h4>Map Request Status</h4>

Click <b>?</b> to display a map request and the response to it.
Some kinds of errors can be displayed.

<h3>Extent</h3>
Enter an extent in the zoom box and click <b>Zoom</b>.

<h3>Auto-Reload</h3>
Check <b>Auto</b> to auto-reload visible overlays with a set frequency.
This allows gathering load time statistics and assessing performance under load.

<h3>Logging</h3>
Enable logging to log all map requests.
				</div>
			</div>


<div class='menu-container'>	
<div  > 
	<div style='text-align:left; margin:10px;width:100%'>
		<span style='width:100%; text-align:right;'><input type='button' id='btn-configure' value='Configure' style='text-align:right'></span>
		<button id='btn-log' class='btn-log' title='Show log'>Log</button>
	</div>
	<div style='text-align:left; margin:10px;width:100%'>
		<button id='btn-redraw-all' class='btn-redraw' title='Reload all overlays'></button>
		Auto
		<input type='checkbox' id='auto-redraw' title='Automatically reload overlays'>
		<input type='text' id='auto-redraw-interval' value='2' disabled style='width:30px; text-align:right;'> sec
	</div>
	<div id='overlays' class='menu-panel'>
			<div style='margin-bottom: 10px; '>
			<div style='font-style: italic; margin-bottom: 10px;'>
					<span style='display:table-cell; width: 30px; text-align: center'><img id='map-spinner' src='img/spinner-30.gif' style='display: none; height: 20px;'/></span>
			</div>
			
		</div>
	</div>
</div>
</div>

<div class='info-container'>
	<div id='info-panel-map'  class='info-panel'>
		<div id='map_div' >
			<div class='zoom-panel'>
				<input type='button' value='Zoom' id='btn-zoom' /><input type='text' id='map-extent' class='map-extent' title='min Lon, min Lat, max Lon, max Lat'>				
			</div>
			
		<!-- Map Status panel -->	
			<div class='map-status-panel'  style='display:none;'>
				<div class='btn-close' id='btn-status-close'>x</div>
				<div style='margin-bottom: 10px;'>Map Request Status</div>	
				<div class='map-url'> Request URL: </div> 
				<div  style='margin-bottom:10px;'>
					<a target='_blank' id='map-status-url-href' href=''><span id='map-status-url'></span></a>
				</div>
					
				<div> Response: </div>
				<div id='map-status' class='http-response'></div>
			</div>
			
		<!-- Log panel -->	
			<div class='map-log-panel' style='display:none;'>
				<div class='btn-close' id='btn-log-close'>x</div>
				<div style='margin-bottom: 10px;'>Log
				- Enable <input type='checkbox' id='log-enabled'>
					</div>	
				<div class='log-text'></div>
			</div>
			
		<!-- Data panel -->	
			<div class='map-data-panel' style='display:none;'>
				<div class='btn-close' id='btn-data-close'>x</div>	
				<div class='data-text'></div>
			</div>
			
			<!-- Config panel -->	
			<div class='config-panel' style='display:none;'>
				<div class='btn-close' id='btn-config-close'>x</div>
				<div>
					<input type='button' value='Current' id='btn-config-show'/>
					<input type='button' value='Current Visible' id='btn-config-show-visible'/>
					<input type='button' value='WMS GetCaps' id='btn-config-wms-load'/>
				</div>
				<textarea id='config-text' placeholder='Enter configuration text'></textarea>
				<div>
					<input type='button' value='Add Map Services' id='btn-config-add'/>
					<input type='button' value='Clear All' id='btn-overlay-clear' style='color:red;right:40px;position:absolute;'/>
				</div>
			</div>
		</div>
	
	</div>
</div>



<script type="text/javascript" src="lib/proj4js-compressed.js"></script>
<script type="text/javascript" src="lib/OpenLayers.js"></script>
<script type="text/javascript" src="lib/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="ol/ScaleEx.js"></script>
<script type="text/javascript" src="urlParams.js"></script>
<script type="text/javascript" src="maptest.js"></script>
<script type="text/javascript" src="Overlay.js"></script>
<script type="text/javascript" src="WMSProof.js"></script>
<script type="text/javascript">

function initPage() {
	
	maptest = new MapTest('map_div');
	var configUrl = loadUrlConfig();
	var showConfigPanel = ! configUrl;
	initUI(showConfigPanel);
	//TESTING();
}

function loadUrlConfig() {
	var config = UrlParams.extract(window.location.search);
	if (! config.host) return null;
	var configTxt = config.host + '\n';
	var lyrs = UrlParams.asArray(config.lyr);
	configTxt += lyrs.join('\n');
	
	maptest.loadConfig(configTxt);
	
	if (config && config.extent) {
		maptest.zoom( config.extent );
	}
	
	return configTxt;
}

function initUI(showConfig)
{
	window.onresize = function() {
		maptest.map.updateSize();
	}
	MapTest.closeAll();
	if (showConfig) {
		MapTest.show('.config-panel');
	}
	$('#btn-status-close').click( MapTest.closeAll );
	$('#btn-log').click(function() { MapTest.show('.map-log-panel'); });
	$('#btn-log-close').click( MapTest.closeAll );
	$('#btn-data-close').click( MapTest.closeAll );
	$('#btn-help').click(function() { MapTest.show('.help-panel'); });
	$('#btn-help-close').click( MapTest.closeAll );
	
	$('#btn-configure').click(function() { MapTest.show('.config-panel');	});
	$('#btn-zoom').click(function() { maptest.zoom( $('#map-extent').val() );	});

	$('#btn-config-close').click( MapTest.closeAll );
	$('#btn-config-add').click(function() { 
		maptest.loadConfig($('#config-text').val());
		//$('#map-link').attr('href', maptest.urlParam());
		$('#config-text').val('');
		$('.config-panel').hide();	
	});
	$('#btn-config-wms-load').click(function() { 
		 $('#config-text').addClass('config-wait');
		var url = $('#config-text').val();
		var prom = maptest.wmsConfig( url )
		prom.done(function( config ) {
			$('#config-text').removeClass('config-wait');
			$('#config-text').val( config );
		} );
		
	});
	$('#btn-config-show-visible').click(function() { $('#config-text').val(maptest.configuration(true));	});
	$('#btn-overlay-clear').click(function() { maptest.clear();	});
			
	$('#btn-redraw-all').click(function() { maptest.redrawMap();	})
	$('#auto-redraw').click(function() { 
    	var doAuto = $(this).is(':checked');
		maptest.autoRedraw(doAuto);	
	})
}
MapTest.log = function(msg) {
	if (! $('#log-enabled').is(':checked')) return;
	$('.log-text').append('<br>' + msg);
}

MapTest.closeAll = function() {
	$('.config-panel').hide();
	$('.map-log-panel').hide();
	$('.map-data-panel').hide();
	$('.map-status-panel').hide();
	$('.help-panel').hide();
}
MapTest.show = function(selector) {
	MapTest.closeAll();
	$(selector).show();
}

function TESTING()
{

}

</script>
	</body>
</html>
